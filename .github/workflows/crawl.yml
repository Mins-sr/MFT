# MFT - è‡ªå‹•å·¡å›ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# 1æ™‚é–“ã”ã¨ã«URLã‚’å·¡å›ã—ã€æ›´æ–°ã‚’æ¤œå‡ºã—ã¦GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤

name: Crawl and Deploy

on:
  # 1æ™‚é–“ã”ã¨ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  schedule:
    - cron: '0 * * * *'  # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
  
  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã‚‚å®Ÿè¡Œï¼ˆåˆæœŸè¨­å®šã®ãŸã‚ï¼‰
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: URLå·¡å›ã‚’å®Ÿè¡Œ
        run: npm run crawl
        env:
          TZ: 'Asia/Tokyo'

      - name: é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰
        run: npm run build
        env:
          TZ: 'Asia/Tokyo'

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --staged --quiet || git commit -m "ğŸ”„ $(date '+%Y-%m-%d %H:%M') ã®è‡ªå‹•å·¡å›çµæœ"
        env:
          TZ: 'Asia/Tokyo'

      - name: å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    needs: crawl
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: main  # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—

      - name: Pages ã®è¨­å®š
        uses: actions/configure-pages@v4

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      - name: GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4
